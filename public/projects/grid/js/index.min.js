var ctx,canvas,winX,winY,gradient,imageObject,inputImage,imageProgress,pr1,pr2,pixelPhotoSize,elFps,elParticle,poss,mouse={x:0,y:0},points=[],maxRange=2e3,maxForce=100,countX=50,countY=50,size=1,minX=.1,minY=.1,maxX=.9,maxY=.9,marginX=100,marginY=100,progressSteps=2500,progressCurr=0,canvasVirtual=document.createElement("canvas"),ctxVirtual=canvasVirtual.getContext("2d"),photoData=[],pixelSize=10,pixelCount=24e3,maxPixelCount=45e3,offsetX=0,offsetY=0,exp=!1,smooth=!1,fps=[];function init(){initPhoto(),initCanvas(),initGradient(),generatePoint(),initSetting(),setInterval(stat,1e3),window.requestAnimationFrame(draw)}function initPhoto(){(inputImage=document.getElementById("image")).addEventListener("change",loadPhoto),imageProgress=document.getElementById("progress"),pr1=document.getElementById("pr-1"),pr2=document.getElementById("pr-2"),elFps=document.getElementById("fps"),elParticle=document.getElementById("particle")}function initCanvas(){canvas=document.getElementById("grid"),window.addEventListener("resize",resizeWindow),canvas.addEventListener("mousemove",mouseMove),canvas.style.cursor="none",resizeWindow(),ctx=canvas.getContext("2d")}function initGradient(){(gradient=ctx.createRadialGradient(100,100,100,100,100,0)).addColorStop(0,"#0b1216"),gradient.addColorStop(.7,"#15292f"),gradient.addColorStop(.9,"#19393e"),gradient.addColorStop(1,"#30767b")}function generatePoint(){points=[];for(var t=minX*winX,e=maxX*winX,n=minY*winY,i=maxY*winY,o=(e-t)/countX,a=(i-n)/countY,s=0,r=0,l=255/countX,p=255/countY,c=t;c<e;c+=o,s+=l){for(var d=n;d<i;d+=a,r+=p)points.push(getPoint(c,d,randColor(s,r)));r=0}}function randColor(t,e,n){return"rgb("+parseInt(105)+", "+parseInt(255-e)+", "+parseInt(t)+")"}function stat(){var t=fps[0]-fps[fps.length-1];elFps.innerHTML="Frame rate: "+Math.floor(1e3*fps.length/t)+" fps",elParticle.innerHTML="Particle: "+points.length}function draw(){ctx.fillStyle="#0b1216",ctx.fillRect(0,0,winX,winY),ctx.save(),ctx.translate(mouse.x-100,mouse.y-100),ctx.beginPath(),ctx.fillStyle=gradient,ctx.fillRect(0,0,200,200),ctx.restore();for(var t=0;t<points.length;t++)poss=setNewPoss(t),ctx.fillStyle=points[t][3],ctx.beginPath(),ctx.fillRect(poss[0],poss[1],pixelSize,pixelSize),ctx.fill();fps.unshift((new Date).getTime()),fps.splice(20),window.requestAnimationFrame(draw)}function mouseMove(t){var e=canvas.getBoundingClientRect();mouse.x=t.clientX-e.left,mouse.y=t.clientY-e.top}function resizeWindow(){winX=window.innerWidth,winY=window.innerHeight,canvas.width=winX,canvas.height=winY}function getPoint(t,e,n){return[[t,e],[t,e],[t,e],n]}function dist(t){return Math.sqrt((mouse.x-t[0][0])*(mouse.x-t[0][0])+(mouse.y-t[0][1])*(mouse.y-t[0][1]))}function setNewPoss(t){var e,n=dist(points[t]);return maxRange<n&&!smooth?points[t][0]:(n=-maxForce/maxRange*n+maxForce,e=Math.atan2(mouse.x-points[t][0][0],points[t][0][1]-mouse.y)+2.5*Math.PI,points[t][1]=exp?[winX/2+Math.cos(e)*n,winY/2+Math.sin(e)*n]:[points[t][0][0]+Math.cos(e)*n,points[t][0][1]+Math.sin(e)*n],smooth&&(points[t][2][0]+=.3*(points[t][1][0]-points[t][2][0]),points[t][2][1]+=.3*(points[t][1][1]-points[t][2][1])),smooth?points[t][2]:points[t][1])}function calculatePhotoSize(t,e){var n=winX-marginX,i=winY-marginY,o=t/e;pixelPhotoSize=n/i<o?(pixelSize=Math.floor(Math.min(t,n)/Math.sqrt(pixelCount*o)),Math.floor(t/Math.sqrt(pixelCount*o))):(pixelSize=Math.floor(Math.min(e,i)/Math.sqrt(pixelCount/o)),Math.floor(e/Math.sqrt(pixelCount/o))),maxPixelCount<t/pixelPhotoSize*(e/pixelPhotoSize)&&(pixelCount/=1.2,calculatePhotoSize(t,e))}function loadPhoto(){imageProgress.parentNode.classList.remove("end"),inputImage.files&&inputImage.files[0]?setTimeout(readImage,500):imageProgress.parentNode.classList.add("end")}function readImage(){var t=new FileReader;imageObject=new Image,t.onload=function(t){imageObject.src=t.target.result,imageObject.onload=function(){setProgress(200,!0),canvasVirtual.width=this.width,canvasVirtual.height=this.height,ctxVirtual.drawImage(imageObject,0,0),calculatePhotoSize(this.width,this.height),setTimeout(prepareDataPixel,1e3)}},t.readAsDataURL(inputImage.files[0])}function prepareDataPixel(){photoData=ctxVirtual.getImageData(0,0,canvasVirtual.width,canvasVirtual.height),offsetX=winX-photoData.width/pixelPhotoSize*pixelSize,offsetY=winY-photoData.height/pixelPhotoSize*pixelSize,points=[];var n=2300/(photoData.width/pixelPhotoSize),i=0;!function t(){for(var e=0;e<photoData.height;e+=pixelPhotoSize)points.push(getPoint(Math.round(offsetX/2+i/pixelPhotoSize*pixelSize),Math.round(offsetY/2+e/pixelPhotoSize*pixelSize),setAveragePixel(i,e)));(i+=pixelPhotoSize)<photoData.width?(setProgress(n,!1),setTimeout(t,10)):(setProgress(2500,!0),loadEnded())}()}function setAveragePixel(t,e){for(var n,i=0,o=0,a=0,s=0,r=Math.min(t+pixelPhotoSize,photoData.width),l=Math.min(e+pixelPhotoSize,photoData.height),p=0,c=e;c<l;c++)for(var d=4*c*photoData.width,u=t;u<r;u++)i+=photoData.data[n=d+4*u],o+=photoData.data[1+n],a+=photoData.data[2+n],s+=photoData.data[3+n],p++;return"rgba( "+(i=parseInt(i/p))+", "+(o=parseInt(o/p))+", "+(a=parseInt(a/p))+", "+(s=parseInt(s/p))+")"}function loadEnded(){imageProgress.parentNode.classList.add("end"),setTimeout(function(){setProgress(0,!0)},500)}function setProgress(t,e){e?progressCurr=t:progressCurr+=t,t=parseInt(progressCurr/progressSteps*100),imageProgress.style.height=t+"%",pr1.innerHTML=t+"%",pr2.innerHTML=t+"%"}function initSetting(){for(var t=document.getElementsByClassName("action"),e=document.getElementsByClassName("input-action"),n=0;n<t.length;n++)t[n].addEventListener("click",inputAction);for(n=0;n<e.length;n++){e[n].addEventListener("input",inputAction);var i=e[n].dataset.var,o=window[i];e[n].value=parseInt(o),document.getElementById(i).innerHTML=o}}function inputAction(){var t=window[this.dataset.action];"function"==typeof t&&t(this)}function openSettings(){mouse.x=winX/2,mouse.y=winY/2,document.body.classList.add("open")}function closeSettings(){document.body.classList.remove("open")}function toggle(t){t=t.dataset.var;window[t]=!window[t]}function setValue(t){var e=t.dataset.var,t=t.value;window[e]=parseInt(t),document.getElementById(e).innerHTML=t}window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/30)},init();