var imgWidth,
    imgHeight,
    divHeight,
    divWidth,
    area,
    areaLey,
    x,
    y,
    empty,
    lx = 3,
    ly = 3,
    divs = [],
    lock = !1;
function newGame(e, i) {
    if (
        ($$.addEvent(window, 'keyup', keypress),
        (area = $$('#puzzleArea')),
        (areaLey = $$('#puzzleAreaLay')),
        (y = window.innerHeight - 75),
        (x = window.innerWidth - 25),
        area.width(x),
        'KOM' === e)
    ) {
        $$('#select').fadeOut(300, function () {
            $$('#puzzleArea').fadeIn(300);
        });
        var t = new FileReader(),
            a = $$('#image');
        (t.onload = function (e) {
            (src = e.target.result), imageInfo();
        }),
            t.readAsDataURL(a.files[0]);
    } else
        'URL' === e
            ? ($$('#select').fadeOut(300, function () {
                  $$('#puzzleArea').fadeIn(300);
              }),
              (src = $$('#photoURL').value),
              imageInfo())
            : ($$('#sample').fadeOut(300, function () {
                  $$('#puzzleArea').fadeIn(300);
              }),
              (src = '/projects/jigsaw/image/img' + (i || 1) + '.jpg'),
              imageInfo());
}
function prepareDivs() {
    for (var e = 0, i = 0; e < ly; e++)
        for (var t = 0; t < lx; t++) {
            i++;
            var a = $$('<div>');
            a
                .addClass('block')
                .height(divHeight)
                .width(divWidth)
                .css(
                    'background',
                    'url(' +
                        src +
                        ') -' +
                        t * divWidth +
                        'px -' +
                        e * divHeight +
                        'px',
                ),
                divs.push(new JigsawElement(a, i));
        }
    divs.pop(), (divs = shuffle(divs));
    for (e = 0, i = 0; e < ly; e++)
        for (t = 0; t < ly && i < divs.length; t++)
            (divs[i].currNum = i + 1),
                divs[i].el.css({
                    left: t * divWidth + 'px',
                    top: e * divHeight + 'px',
                }),
                areaLey.appendChild(divs[i].el),
                i++;
}
function imageInfo() {
    var e = new Image();
    (e.onload = function () {
        (imgWidth = e.width),
            (imgHeight = e.height),
            imgWidth > x
                ? $$.delay(function () {
                      $$('#select').show(),
                          $$('#puzzleArea').hide(),
                          showMSG('Zbyt wielki rozmiar obrazka!', 0);
                  }, 1e3)
                : ($$('#puzzleAreaLay')
                      .width(imgWidth + 0.01 + 2 * lx)
                      .height(imgHeight + 0.01 + 2 * ly)
                      .show(),
                  ($$('#imageView').src = src),
                  ($$('#imageView').height = (imgWidth / imgHeight) * 200),
                  $$('#imageView').show(),
                  (divHeight = imgHeight / ly),
                  (divWidth = imgWidth / lx),
                  (empty = ly * lx),
                  prepareDivs());
    }),
        (e.src = src);
}
function keypress(e) {
    switch (e.keyCode) {
        case 37:
            empty % lx && move(empty + 1, -1, 0), e.stopPropagation();
            break;
        case 39:
            (empty - 1) % lx && move(empty - 1, 1, 0), e.stopPropagation();
            break;
        case 40:
            empty - lx > 0 && move(empty - lx, 0, 1), e.stopPropagation();
            break;
        case 38:
            empty + lx <= lx * ly && move(empty + lx, 0, -1), e.stopPropagation();
    }
}
function move(e, i, t) {
    if (!lock) {
        var a = getElement(e),
            r = a.currNum;
        (a.currNum = empty), (empty = r);
        var n = parseFloat(a.el.css('top')),
            o = parseFloat(a.el.css('left'));
        a.el.css({left: o + i * divWidth + 'px', top: n + t * divHeight + 'px'}),
            (lock = !0),
            checkWin()
                ? showMSG('Brawo! Udało Ci się ułożyć wszystkie elementy', 1)
                : setTimeout(function () {
                      lock = !1;
                  }, 110);
    }
}
function checkWin() {
    for (var e = !0, i = 0; i < divs.length; i++)
        divs[i].currNum !== divs[i].passNum && (e = !1);
    return e;
}
function getElement(e) {
    for (var i = 0; i < divs.length; i++) if (divs[i].currNum === e) return divs[i];
}
function shuffle(e) {
    for (
        var i, t, a = e.length;
        a;
        i = Math.floor(Math.random() * a), t = e[--a], e[a] = e[i], e[i] = t
    );
    return e;
}
function imageExists() {
    var e = new Image();
    (e.onload = function () {
        $$('.URL').hide(), newGame('URL');
    }),
        (e.onerror = function () {
            showMSG('Nie znaleziono obarazka o podanym URL', 0);
        }),
        (e.src = $$('#photoURL').value);
}
function showMSG(e, i) {
    $$('.MSG')
        .fadeIn()
        .setText(e)
        .removeClass('ok')
        .removeClass('error')
        .addClass(i ? 'ok' : 'error');
}
function reset() {
    $$('#puzzleArea').fadeOut(300, function () {
        $$('#select').fadeIn(300), $$('#puzzleAreaLay').empty();
    }),
        $$('#sample').hide(),
        $$('.MSG').hide(),
        ($$('#imageView').src = ''),
        $$('#imageView').hide(),
        (divs = []),
        (lock = !1);
}
function JigsawElement(e, i) {
    (this.el = e), (this.passNum = i), (this.currNum = 0);
}
document.querySelector('#reset').addEventListener('click', reset),
    document.querySelector('#select1').addEventListener('click', () => {
        $$('.URL').hide(), $$('#image').click();
    }),
    document.querySelector('#select2').addEventListener('click', () => {
        $$('.URL').fadeIn();
    }),
    document.querySelector('#select3').addEventListener('click', () => {
        $$('.URL').hide(),
            $$('#select').fadeOut(300, function () {
                $$('#sample').fadeIn(300);
            });
    }),
    document.querySelector('#confirmURL').addEventListener('click', imageExists),
    document.querySelector('#message').addEventListener('click', (e) => {
        $$(e.currentTarget).fadeOut();
    }),
    document.querySelector('#image').addEventListener('change', () => {
        newGame('KOM');
    });
