let activeBox=[],inputBox=[];const period={h:null,min:null,sec:null},distance={km:null,m:null},speed={km_h:null,m_s:null},pace={min:null,sec:null},table={renderPeriod:0,timeout:500,body:null,header:{top:null,side:null},style:null,activeRow:-1,activeCol:-1};function init(){addTableStyle(),inputEvent(),setInput(),initTable(),initDefault()}function setInput(){period.h=document.getElementById("run-period-h"),period.min=document.getElementById("run-period-m"),period.sec=document.getElementById("run-period-s"),distance.km=document.getElementById("run-distance-km"),distance.m=document.getElementById("run-distance-m"),pace.min=document.getElementById("run-pace-m"),pace.sec=document.getElementById("run-pace-s"),speed.km_h=document.getElementById("run-speed-km-h"),speed.m_s=document.getElementById("run-speed-m-s"),inputBox=document.querySelectorAll(".input-area")}function initTable(){table.body=document.getElementById("run-table-body"),table.header.top=document.getElementById("run-table-header-top"),table.header.side=document.getElementById("run-table-header-side");const e=document.querySelectorAll("td");for(let t=0;t<e.length;t++)e[t].addEventListener("mouseover",activeCell);table.body.addEventListener("mouseleave",loseActive),table.body.addEventListener("mousemove",activeCell)}function initDefault(){distance.km.value=10,period.min.value=45,active(distance.km),active(period.min),valid(period.min,0)}function addTableStyle(){table.style=document.createElement("style"),document.head.appendChild(table.style)}function activeCell(e){const t=e.target;if("td"===t.tagName.toLowerCase()){const e=t.cellIndex+1,n=t.parentNode.rowIndex+1;(e!==table.activeCol||n!==table.activeRow)&&n>1&&e>1&&(table.style.innerHTML=".table-body .table-main table tr:nth-child("+n+") {background-color: rgba(255, 255, 255, 0.7);color: black;font-weight: bold;}.table-body .table-main table tr td:nth-child("+e+") {background-color: rgba(255, 255, 255, 0.7);color: black;font-weight: bold;}")}}function loseActive(){table.activeRow=-1,table.activeCol=-1,table.style.innerHTML=""}function recalculateSpeed(e){let t;"s_km"===e?setSpeed(skm_to_ms(getPace())):"km_h"===e?(t=kmh_to_ms(getSpeed("km_h")),setSpeed(t,"m_s"),setPace(ms_to_skm(t))):"m_s"===e&&(t=getSpeed("m_s"),setSpeed(ms_to_kmh(t),"km_h"),setPace(ms_to_skm(t)))}function recalculate(){if(2===activeBox.length){let e,t,n;table.renderPeriod=timestamp(table.timeout);const a=[activeBox[0].dataset.type,activeBox[1].dataset.type],i=getSpeed(),r=getPace(),o=getPeriod(),s=getDistance();if(inArrayValues("period","distance",a)){if(!validValue(o,s))return!1;n="pace",e="distance",t="period",setPace(calculateVal(n,s,e,o,t)),setSpeed(s/o)}else if(inArrayValues("period","pace",a)){if(!validValue(o,r))return!1;n="distance",e="period",t="pace",setDistance(calculateVal(n,o,e,r,t))}else if(inArrayValues("period","speed",a)){if(!validValue(o,i))return!1;n="distance",e="period",t="speed",setDistance(calculateVal(n,o,e,i,t))}else if(inArrayValues("distance","pace",a)){if(!validValue(s,r))return!1;n="period",e="distance",t="pace",setPeriod(calculateVal(n,s,e,r,t))}else{if(!inArrayValues("distance","speed",a))return!1;if(!validValue(s,i))return!1;n="period",e="distance",t="speed",setPeriod(calculateVal(n,s,e,i,t))}setTimeout((function(){renderTable(e,t,n)}),table.timeout+200)}}function validValue(e,t){return e>0&&t>0}function calculateVal(e,t,n,a,i){return 0===t||0===a?0:"pace"===e&&"distance"===n&&"period"===i?ms_to_skm(t/a):"distance"===e&&"period"===n&&"pace"===i?t/a*1e3:"distance"===e&&"period"===n&&"speed"===i?t*a:"period"===e&&"distance"===n&&"pace"===i?t*a/1e3:"period"===e&&"distance"===n&&"speed"===i?t/a:void 0}function formatVal(e,t){if("period"===e){const e=parsePeriod(t);return(0!==e.h?e.h+":":"")+twoChar(e.min)+":"+twoChar(e.sec)}if("distance"===e){const e=parseDistance(t);return e.km+"km "+(0!==e.m?e.m+"m":"")}if("speed"===e)return fixNumber(ms_to_kmh(t),3)+"km/h";if("pace"===e){const e=parsePace(t);return twoChar(e.min)+"':"+twoChar(e.sec)+'"'}}function twoChar(e){return e<10&&(e="0"+e),e}function setPeriod(e){const t=parsePeriod(e);period.h.value=t.h,period.min.value=t.min,period.sec.value=t.sec}function setSpeed(e,t){(t=t||!1)?"m_s"===t?speed.m_s.value=speedFormat(e):"km_h"===t&&(speed.km_h.value=speedFormat(e)):(speed.m_s.value=speedFormat(e),speed.km_h.value=speedFormat(ms_to_kmh(e)))}function setPace(e){const t=parsePace(e);pace.min.value=t.min,pace.sec.value=t.sec}function setDistance(e){const t=parseDistance(e);distance.km.value=t.km,distance.m.value=t.m}function parseDistance(e){let t=floor(e/1e3);return 1e3===(e=round(e-=1e3*t))&&(e=0,t++),{km:t,m:e}}function parsePeriod(e){const t=floor(e/3600),n=floor((e-=3600*t)/60);return fixPeriod({h:t,min:n,sec:e-=60*n})}function parsePace(e){const t=floor(e/60);return fixPeriod({h:0,min:t,sec:e-=60*t})}function fixPeriod(e){return e.sec=round(e.sec),60===e.sec&&(e.sec=0,e.min++),60===e.min&&(e.min=0,e.h++),e}function getDistance(){return 1e3*value(distance.km)+value(distance.m)}function getSpeed(e){return value("m_s"===(e=e||"m_s")?speed.m_s:speed.km_h)}function getPeriod(){return 3600*value(period.h)+60*value(period.min)+value(period.sec)}function getPace(){return 60*value(pace.min)+value(pace.sec)}function value(e){const t=float(e.value);return isNaN(t)?0:t}function inputEvent(){const e=document.getElementsByTagName("input");for(let t=0;t<e.length;t++)"text"===e[t].type?(e[t].addEventListener("keydown",validNumber),e[t].addEventListener("focus",active)):"button"===e[t].type&&e[t].addEventListener("click",selectDistance)}function isEqual(e,t,n){return e[t]&&e[t].dataset.type===n}function selectDistance(){const e=this.dataset.type;let t;"distance"===e?(distance.km.value=this.dataset.km,distance.m.value=this.dataset.m,t=distance.km):"pace"===e?(pace.min.value=this.dataset.min,pace.sec.value=this.dataset.sec,t=pace.min):"period"===e?(period.h.value=this.dataset.h,period.min.value=this.dataset.min,period.sec.value=this.dataset.sec,t=period.h):"speed"===e&&(speed.km_h.value=this.dataset.km_h,speed.m_s.value=this.dataset.m_s,t=speed.km_h),active(t),valid(t,0)}function active(e){const t=getParent(e=e.target?e.target:e,"input-area"),n=t.dataset.type,a="pace"===n?"speed":"speed"===n&&"pace";a&&(isEqual(activeBox,1,a)&&activeBox.splice(1,1),isEqual(activeBox,0,a)&&activeBox.splice(0,1)),t.classList.contains("active")||(t.classList.add("active"),activeBox.push(t));const i=activeBox.length-2;i>0&&activeBox.splice(0,i),t.dataset.type===activeBox[0].dataset.type&&(activeBox=activeBox.reverse()),setActiveBoxes()}function setActiveBoxes(){for(let e=0;e<inputBox.length;e++)inputBox[e].classList.remove("active");for(let e=0;e<activeBox.length;e++)activeBox[e].classList.add("active")}function validNumber(e){const t=e.keyCode||e.charCode,n=this;if(38===t)valid(n,1);else{if(40!==t)return inArray(t,[46,8,9,27,13,110,188,190])?(setTimeout((function(){valid(n,0)}),100),!0):(setTimeout((function(){valid(n,0)}),100),t>=48&&t<=57||t>=96&&t<=105);valid(n,-1)}}function valid(e,t){let n=e.value.replace(",",".");if("."!==n.slice(-1)){n=float(n)+t;const a=int(e.dataset.max);n<=0&&(n=0),n>=a&&(n=a)}e.value=n,e.dataset&&e.dataset.hasOwnProperty("type")&&recalculateSpeed(e.dataset.type),recalculate()}function float(e){return fixNan(parseFloat(+e))}function fixNan(e){return isNaN(e)?0:e}function speedFormat(e){return abs(int(e)-float(e).toFixed(1))<.1?int(e):float(e).toFixed(1)}function int(e){return fixNan(parseInt(+e))}function floor(e){return Math.floor(e)}function round(e){return Math.round(e)}function abs(e){return Math.abs(e)}function inArray(e,t){return-1!==t.indexOf(e)}function inArrayValues(e,t,n){return inArray(e,n)&&inArray(t,n)}function maxArray(e){return Math.max.apply(null,e)}function minArray(e){return Math.min.apply(null,e)}function sortArray(e){return e.sort((function(e,t){return e-t}))}function ms_to_kmh(e){return 3.6*e}function kmh_to_ms(e){return e/3.6}function ms_to_skm(e){return 0===e?0:1e3/e}function skm_to_ms(e){return 0===e?0:1e3/e}function timestamp(e){return e=e||0,(new Date).getTime()+e}function getParent(e,t){const n=e.parentNode;return n?n.classList.contains(t)?n:getParent(n,t):null}function renderTable(e,t,n){if(timestamp()>table.renderPeriod){renderTableBody(n,getRangeByName(e,getColumnCount()),e,getRangeByName(t,20),t),setTableTitle(e,t)}}function getRangeByName(e,t){return"period"===e?getPeriodRange(getPeriod(),t):"pace"===e?getPaceRange(getPace(),t):"speed"===e?getSpeedRange(getSpeed("km_h"),t):"distance"===e?getDistanceRange(getDistance(),t):void 0}function getPaceRange(e,t){return getRange(e,t/2,t,120,600)}function getDistanceRange(e,t){const n=[21097,42195],a=getRange(1e3*round(e/1e3),500*t,t,1e3,2e5);return minArray(a)<n[0]&&n[0]<maxArray(a)&&a.push(n[0]),minArray(a)<n[1]&&n[1]<maxArray(a)&&a.push(n[1]),inArray(e,a)||a.push(e),sortArray(a)}function getSpeedRange(e,t){let n=getRange(e,t/4,t,1,30);return n=n.map((function(e){return kmh_to_ms(e)})),inArray(kmh_to_ms(e),n)||n.push(kmh_to_ms(e)),sortArray(n)}function getPeriodRange(e,t){const n=getRange(60*round(e/60),30*t,t,10,2e6);return inArray(e,n)||n.push(e),sortArray(n)}function renderTableBody(e,t,n,a,i){let r,o,s=renderTopHeader(t,n);for(let c=0;c<a.length;c++){r=td(formatVal(i,a[c]));for(let s=0;s<t.length;s++)o=calculateVal(e,t[s],n,a[c],i),r+=td(formatVal(e,o));s+=tr(r)}table.body.innerHTML=s}function renderTopHeader(e,t){let n=td("");for(let a=0;a<e.length;a++)n+=td(formatVal(t,e[a]));return tr(n)}function tr(e){return"<tr>"+e+"</tr>"}function td(e){return"<td>"+e+"</td>"}function setTableTitle(e,t){table.header.top.innerHTML=label[e],table.header.side.innerHTML=label[t]}function getColumnCount(){const e=round(table.body.offsetWidth/60-11/6)-1;return Math.min(10,Math.max(3,e))}function getRange(e,t,n,a,i){e<a&&(e=a),e>i&&(e=i),e=fixNumber(e);let r=Math.max(e-t,a),o=Math.min(e+t,i);const s=fixNumber((o-r)/n);r=e-int((e-r)/s)*s,o=e+int((o-e)/s)*s;const c=[];for(let e=r;e<=o;e+=s)c.push(fixNumber(e,5));return c}function fixNumber(e,t){t=t-1||1,e=float(e);let n=0;for(;e<Math.pow(10,t);)e*=10,n++;return Math.round(e)/Math.pow(10,n)}label={period:"Czas",speed:"Prędkość",pace:"Tempo",distance:"Dystans"},init();