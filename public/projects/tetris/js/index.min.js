let isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),numX=10,numY=16,LenCub=20,boardX=numX*LenCub,boardY=numY*LenCub,boardXwithMenu=boardX+100,BoardColor="#678893",stX=4,stY=0,OneInLoop=0,canvas,ctx,gameLoop,downPress=!1,leftPress=!1,rightPress=!1,NumberCube=Math.floor(1e4*Math.random())%7,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1,titleFontSize="bold 24px Georgia",MenuFontSize="bold 14px Georgia",Score=0,Level=1,initSpeed=10,Speed=10,fps=60,move=0,ColorCube={cub0:"#33CC33",cube0:"#259525",cub1:"#C670C6",cube1:"#9E5A9E",cub2:"#D1A319",cube2:"#A98414",cub3:"#FF6666",cube3:"#CC5252",cub4:"#5C5CD6",cube4:"#5353C1",cub5:"#E6E600",cube5:"#B8B800",cub6:"#FF8533",cube6:"#D1793E"};function startTetris(){ResetGame(),gameLoop=setInterval(DrawAll,fps)}function END(e){move=0,e&&(rightPress=!1),e||(leftPress=!1)}function LR(e){rightPress=e,leftPress=!e,move=0,MoveCubeLR(e)}function initCanvas(){(canvas=document.getElementById("tetris")).height=boardY,canvas.width=boardXwithMenu,canvas.getContext&&(ctx=canvas.getContext("2d"),DrawAll(),DrawMenu()),window.addEventListener("keydown",keyPress,!0),window.addEventListener("keyup",keyUp,!0),document.querySelector(".rotate").addEventListener("click",TransformCube);var e=document.querySelector(".move-right"),e=(isMobile&&e.addEventListener("touchstart",function(){LR(!0)}),isMobile||e.addEventListener("mousedown",function(){LR(!0)}),e.addEventListener("mouseup",function(){END(!0)}),e.addEventListener("touchend",function(){END(!0)}),document.querySelector(".move-left")),e=(isMobile&&e.addEventListener("touchstart",function(){LR(!1)}),isMobile||e.addEventListener("mousedown",function(){LR(!1)}),e.addEventListener("mouseup",function(){END(!1)}),e.addEventListener("touchend",function(){END(!1)}),document.querySelector(".move-down"));isMobile&&e.addEventListener("touchstart",function(){downPress=!0,MoveCube()}),isMobile||e.addEventListener("mousedown",function(){downPress=!0,MoveCube()}),e.addEventListener("mouseup",function(){downPress=!1}),e.addEventListener("touchend",function(){downPress=!1})}function Block(e,o,r,t){this.poss=e,this.type=o,this.color=r,this.colorN=t}let AllBlock=[new Block([[stX,stY],[stX,stY+1],[stX,stY+2],[stX+1,stY+2]],1,ColorCube.cub0,ColorCube.cube0),new Block([[stX,stY],[stX,stY+1],[stX,stY+2],[stX-1,stY+2]],2,ColorCube.cub1,ColorCube.cube1),new Block([[stX,stY],[stX+1,stY],[stX+1,stY+1],[stX+2,stY+1]],3,ColorCube.cub2,ColorCube.cube2),new Block([[stX,stY],[stX+1,stY],[stX,stY+1],[stX-1,stY+1]],4,ColorCube.cub3,ColorCube.cube3),new Block([[stX,stY],[stX+1,stY],[stX+2,stY],[stX+3,stY]],5,ColorCube.cub4,ColorCube.cube4),new Block([[stX,stY],[stX,stY+1],[stX-1,stY+1],[stX+1,stY+1]],6,ColorCube.cub5,ColorCube.cube5),new Block([[stX,stY],[stX+1,stY],[stX,stY+1],[stX+1,stY+1]],7,ColorCube.cub6,ColorCube.cube6)];function OneCube(e,o,r,t){this.X=e,this.Y=o,this.value=r,this.color=t}let Board=[],CubeArea=[],NewArea=[];for(var i=0;i<numY;i++){Board[i]=[],CubeArea[i]=[],NewArea[i]=[];for(var j=0;j<numX;j++)Board[i][j]=new OneCube(LenCub*j,LenCub*i,1,BoardColor),NewArea[i][j]=new OneCube(LenCub*j,LenCub*i,!1,BoardColor),CubeArea[i][j]=new OneCube(LenCub*j,LenCub*i,!1,BoardColor)}function ResetGame(){document.querySelector(".play").style.display="none",Score=0,move=0,Level=1,Speed=initSpeed,NumberCube=Math.floor(1e4*Math.random())%7,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1,ResetPosition();for(let o=0;o<numY;o++)for(let e=0;e<numX;e++)Board[o][e].color=BoardColor,CubeArea[o][e].color=BoardColor,CubeArea[o][e].value=!1,NewArea[o][e].color=BoardColor}function DrawAll(){ctx.beginPath(),ctx.fillStyle=BoardColor,ctx.fillRect(0,0,boardX,boardY),ctx.beginPath(),ctx.moveTo(boardX,0),ctx.lineTo(boardX,boardY),ctx.stroke();for(var e=0;e<numY;e++)for(var o=0;o<numX;o++)Board[e][o].color=BoardColor;for(e=0;e<numY;e++)for(o=0;o<numX;o++)CubeArea[e][o].value&&(ctx.fillStyle=CubeArea[e][o].color,ctx.beginPath(),ctx.rect(CubeArea[e][o].X+1,CubeArea[e][o].Y+1,LenCub-2,LenCub-2),ctx.closePath(),ctx.fill());for(e=0;e<4;e++){var r=AllBlock[NumberCube].poss[e][0],t=AllBlock[NumberCube].poss[e][1];ctx.fillStyle=AllBlock[NumberCube].color,ctx.beginPath(),ctx.rect(Board[t][r].X+1,Board[t][r].Y+1,LenCub-2,LenCub-2),ctx.closePath(),ctx.fill()}0!==OneInLoop&&!downPress||MoveCube(),move&&leftPress&&MoveCubeLR(!1),move&&rightPress&&MoveCubeLR(!0),move++,OneInLoop=++OneInLoop%Speed}function DrawMenu(){ctx.beginPath(),ctx.fillStyle=BoardColor,ctx.fillRect(boardX,0,boardXwithMenu,boardY),ctx.beginPath(),ctx.font=MenuFontSize,ctx.fillStyle="white",ctx.fillText("Next block ",boardX+8,20),ctx.fillText("Score: "+Score,boardX+8,110),ctx.fillText("Level: "+Level,boardX+8,130),DrawNextBlock()}function DrawNextBlock(){switch(NumberNextCube){case 0:DrawOneCube(boardX+15,30),DrawOneCube(boardX+15,50),DrawOneCube(boardX+15,70),DrawOneCube(boardX+35,70);break;case 1:DrawOneCube(boardX+35,30),DrawOneCube(boardX+35,50),DrawOneCube(boardX+35,70),DrawOneCube(boardX+15,70);break;case 2:DrawOneCube(boardX+35,30),DrawOneCube(boardX+35,50),DrawOneCube(boardX+15,50),DrawOneCube(boardX+15,70);break;case 3:DrawOneCube(boardX+15,30),DrawOneCube(boardX+15,50),DrawOneCube(boardX+35,50),DrawOneCube(boardX+35,70);break;case 4:DrawOneCube(boardX+10,30),DrawOneCube(boardX+30,30),DrawOneCube(boardX+50,30),DrawOneCube(boardX+70,30);break;case 5:DrawOneCube(boardX+35,30),DrawOneCube(boardX+15,50),DrawOneCube(boardX+35,50),DrawOneCube(boardX+55,50);break;case 6:DrawOneCube(boardX+15,30),DrawOneCube(boardX+15,50),DrawOneCube(boardX+35,50),DrawOneCube(boardX+35,30)}}function DrawOneCube(e,o){ctx.fillStyle=AllBlock[NumberNextCube].color,ctx.beginPath(),ctx.rect(e+1,o+1,LenCub-2,LenCub-2),ctx.closePath(),ctx.fill()}function ChoseNextCube(){for(let e=0;e<4;e++)CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]].value=!0,CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]].color=AllBlock[NumberCube].colorN;ResetPosition(),DeleteFullLayer(),NumberCube=NumberNextCube,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1,CheckStatusGame(),DrawMenu()}function GameEnd(){clearInterval(gameLoop),ctx.font=titleFontSize,ctx.fillStyle="white",ctx.fillText("GAME OVER",15,130),document.querySelector(".play").style.display="block"}function CheckStatusGame(){for(let e=0;e<numX;e++)if(!0===CubeArea[0][e].value)return GameEnd()}function DeleteFullLayer(){let e=0;for(var o=0;o<numY;o++)for(var r=0;r<numX;r++)NewArea[o][r].value=CubeArea[o][r].value,NewArea[o][r].color=CubeArea[o][r].color;for(o=0;o<numY;o++){for(r=0;r<numX;r++)!0===CubeArea[o][r].value&&e++;if(e===numX){Score++,Level=Math.ceil(Score/40),Speed=initSpeed-Level;for(var t=0;t<=o;t++)for(var s=0;s<numX;s++)0===t?(NewArea[t][s].value=!1,NewArea[t][s].color=BoardColor):(NewArea[t][s].value=CubeArea[t-1][s].value,NewArea[t][s].color=CubeArea[t-1][s].color);for(t=0;t<numY;t++)for(s=0;s<numX;s++)CubeArea[t][s].value=NewArea[t][s].value,CubeArea[t][s].color=NewArea[t][s].color}e=0}}function MoveCube(){let e=0;for(var o=0;o<4;o++)AllBlock[NumberCube].poss[o][1]+1!==numY&&!0!==CubeArea[AllBlock[NumberCube].poss[o][1]+1][AllBlock[NumberCube].poss[o][0]].value||e++;if(0===e)for(o=0;o<4;o++)AllBlock[NumberCube].poss[o][1]++;else ChoseNextCube()}function ResetPosition(){switch(NumberCube){case 0:AllBlock[NumberCube].poss=[[stX,stY],[stX,stY+1],[stX,stY+2],[stX+1,stY+2]];break;case 1:AllBlock[NumberCube].poss=[[stX,stY],[stX,stY+1],[stX,stY+2],[stX-1,stY+2]];break;case 2:AllBlock[NumberCube].poss=[[stX,stY],[stX+1,stY],[stX+1,stY+1],[stX+2,stY+1]];break;case 3:AllBlock[NumberCube].poss=[[stX,stY],[stX+1,stY],[stX,stY+1],[stX-1,stY+1]];break;case 4:AllBlock[NumberCube].poss=[[stX,stY],[stX+1,stY],[stX+2,stY],[stX+3,stY]];break;case 5:AllBlock[NumberCube].poss=[[stX,stY],[stX,stY+1],[stX-1,stY+1],[stX+1,stY+1]];break;case 6:AllBlock[NumberCube].poss=[[stX,stY],[stX+1,stY],[stX,stY+1],[stX+1,stY+1]]}}function MoveCubeLR(e){let o=0,r=0;for(let e=0;e<4;e++)AllBlock[NumberCube].poss[e][0]+1!==numX&&!0!==CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]+1].value||r++,(0===AllBlock[NumberCube].poss[e][0]||!0===CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]-1].value)&&o++;if(e&&0===r)for(let e=0;e<4;e++)AllBlock[NumberCube].poss[e][0]++;if(!e&&0===o)for(let e=0;e<4;e++)AllBlock[NumberCube].poss[e][0]--}function TransformCube(){for(var e=[[],[],[],[]],o=0;o<4;o++)e[o][0]=AllBlock[NumberCube].poss[o][0],e[o][1]=AllBlock[NumberCube].poss[o][1];let r=NumTransform,t=0;switch(NumberCube){case 0:if(1===r){if(0===e[0][0])break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,r++}else if(2===r){if(e[0][1]===numY-1)break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][0]-=2,r++}else if(3===r){if(e[0][0]===numX-1)break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,r++}else if(4===r){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][0]+=2,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 1:if(1===r){if(e[0][0]===numX-1)break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]+=2,r++}else if(2===r){if(0===e[0][1])break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][1]-=2,r++}else if(3===r){if(0===e[0][0])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]-=2,r++}else if(4===r){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][1]+=2,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 2:if(1===r||3===r){if(0===e[0][1]||e[3][1]===numY-1)break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,r++}else if(2===r||4===r){if(e[0][1]===numY-1||0===e[0][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 3:if(1===r||3===r){if(0===e[1][1]||e[3][1]===numY-1)break;e[1][0]--,e[1][1]--,e[2][0]++,e[2][1]--,e[3][0]+=2,r++}else if(2===r||4===r){if(e[1][1]===numY-1||0===e[1][0])break;e[1][0]++,e[1][1]++,e[2][0]--,e[2][1]++,e[3][0]-=2,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 4:if(1===r||3===r){if(0===e[3][1]||e[3][1]>numY-3)break;e[0][0]+=2,e[0][1]+=2,e[1][0]++,e[1][1]++,e[3][0]--,e[3][1]--,r++}else if(2===r||4===r){if(e[1][0]===numX-1||e[1][0]<2||e[0][1]===numY-1)break;e[0][0]-=2,e[0][1]-=2,e[1][0]--,e[1][1]--,e[3][0]++,e[3][1]++,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 5:if(1===r){if(e[3][1]===numY-1)break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]++,e[3][0]--,e[3][1]--,r++}else if(2===r){if(e[2][1]===numY-1||e[2][0]===numX-1)break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]--,e[3][1]++,r++}else if(3===r){if(e[0][1]===numY-1||0===e[3][1])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]--,e[3][0]++,e[3][1]++,r++}else if(4===r){if(e[3][1]===numY-1||0===e[3][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]++,e[3][1]--,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&t++;0===t&&(AllBlock[NumberCube].poss=e,NumTransform=r)}}function keyUp(e){switch(e.keyCode){case 65:case 37:leftPress=!1,e.stopPropagation();break;case 68:case 39:rightPress=!1,e.stopPropagation();break;case 83:case 40:downPress=!1,e.stopPropagation()}}function keyPress(e){switch(move=0,e.keyCode){case 65:case 37:rightPress=!1,leftPress=!0,e.stopPropagation();break;case 68:case 39:leftPress=!1,rightPress=!0,e.stopPropagation();break;case 87:case 38:TransformCube(),e.stopPropagation();break;case 83:case 40:downPress=!0,e.stopPropagation()}}initCanvas();