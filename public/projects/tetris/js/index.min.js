let e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),r=10,i=16,s=20,n=r*s,l=i*s,G=n+100,f="#678893",o=4,t=0,c=0,a,u,N,d=!1,p=!1,v=!1,b=Math.floor(1e4*Math.random())%7,k=Math.floor(1e4*Math.random())%7,h=1,O="bold 24px Georgia",R="bold 14px Georgia",w=0,y=1,X=10,E=10,g=0;const Y="#33CC33",V="#259525",j="#C670C6",z="#9E5A9E",H="#D1A319",J="#A98414",K="#FF6666",Q="#CC5252",U="#5C5CD6",W="#5353C1",Z="#E6E600",$="#B8B800",_="#FF8533",ee="#D1793E";function m(e){g=0,e&&(v=!1),e||(p=!1)}function P(e){v=e,p=!e,g=0,D(e)}function L(e,o,t,a){this.poss=e,this.type=o,this.color=t,this.colorN=a}let S=[new L([[o,t],[o,t+1],[o,t+2],[o+1,t+2]],1,Y,V),new L([[o,t],[o,t+1],[o,t+2],[o-1,t+2]],2,j,z),new L([[o,t],[o+1,t],[o+1,t+1],[o+2,t+1]],3,H,J),new L([[o,t],[o+1,t],[o,t+1],[o-1,t+1]],4,K,Q),new L([[o,t],[o+1,t],[o+2,t],[o+3,t]],5,U,W),new L([[o,t],[o,t+1],[o-1,t+1],[o+1,t+1]],6,Z,$),new L([[o,t],[o+1,t],[o,t+1],[o+1,t+1]],7,_,ee)];function M(e,o,t,a){this.X=e,this.Y=o,this.value=t,this.color=a}let C=[],x=[],T=[];for(var q,A=0;A<i;A++){C[A]=[],x[A]=[],T[A]=[];for(var B=0;B<r;B++)C[A][B]=new M(s*B,s*A,1,f),T[A][B]=new M(s*B,s*A,!1,f),x[A][B]=new M(s*B,s*A,!1,f)}function oe(){u.beginPath(),u.fillStyle=f,u.fillRect(0,0,n,l),u.beginPath(),u.moveTo(n,0),u.lineTo(n,l),u.stroke();for(var e=0;e<i;e++)for(var o=0;o<r;o++)C[e][o].color=f;for(e=0;e<i;e++)for(o=0;o<r;o++)x[e][o].value&&(u.fillStyle=x[e][o].color,u.beginPath(),u.rect(x[e][o].X+1,x[e][o].Y+1,s-2,s-2),u.closePath(),u.fill());for(e=0;e<4;e++){var t=S[b].poss[e][0],a=S[b].poss[e][1];u.fillStyle=S[b].color,u.beginPath(),u.rect(C[a][t].X+1,C[a][t].Y+1,s-2,s-2),u.closePath(),u.fill()}0!==c&&!d||I(),g&&p&&D(!1),g&&v&&D(!0),g++,c=++c%E}function te(){switch(u.beginPath(),u.fillStyle=f,u.fillRect(n,0,G,l),u.beginPath(),u.font=R,u.fillStyle="white",u.fillText("Next block ",n+8,20),u.fillText("Score: "+w,n+8,110),u.fillText("Level: "+y,n+8,130),k){case 0:F(n+15,30),F(n+15,50),F(n+15,70),F(n+35,70);break;case 1:F(n+35,30),F(n+35,50),F(n+35,70),F(n+15,70);break;case 2:F(n+35,30),F(n+35,50),F(n+15,50),F(n+15,70);break;case 3:F(n+15,30),F(n+15,50),F(n+35,50),F(n+35,70);break;case 4:F(n+10,30),F(n+30,30),F(n+50,30),F(n+70,30);break;case 5:F(n+35,30),F(n+15,50),F(n+35,50),F(n+55,50);break;case 6:F(n+15,30),F(n+15,50),F(n+35,50),F(n+35,30)}}function F(e,o){u.fillStyle=S[k].color,u.beginPath(),u.rect(e+1,o+1,s-2,s-2),u.closePath(),u.fill()}function ae(){for(let e=0;e<4;e++)x[S[b].poss[e][1]][S[b].poss[e][0]].value=!0,x[S[b].poss[e][1]][S[b].poss[e][0]].color=S[b].colorN;se();{let e=0;for(var o=0;o<i;o++)for(var t=0;t<r;t++)T[o][t].value=x[o][t].value,T[o][t].color=x[o][t].color;for(o=0;o<i;o++){for(t=0;t<r;t++)!0===x[o][t].value&&e++;if(e===r){w++,y=Math.ceil(w/40),E=X-y;for(var a=0;a<=o;a++)for(var s=0;s<r;s++)0===a?(T[a][s].value=!1,T[a][s].color=f):(T[a][s].value=x[a-1][s].value,T[a][s].color=x[a-1][s].color);for(a=0;a<i;a++)for(s=0;s<r;s++)x[a][s].value=T[a][s].value,x[a][s].color=T[a][s].color}e=0}}b=k,k=Math.floor(1e4*Math.random())%7,h=1,function(){for(let e=0;e<r;e++)if(!0===x[0][e].value)return clearInterval(N),u.font=O,u.fillStyle="white",u.fillText("GAME OVER",15,130),document.querySelector(".play").style.display="block"}(),te()}function I(){let e=0;for(var o=0;o<4;o++)S[b].poss[o][1]+1!==i&&!0!==x[S[b].poss[o][1]+1][S[b].poss[o][0]].value||e++;if(0===e)for(o=0;o<4;o++)S[b].poss[o][1]++;else ae()}function se(){switch(b){case 0:S[b].poss=[[o,t],[o,t+1],[o,t+2],[o+1,t+2]];break;case 1:S[b].poss=[[o,t],[o,t+1],[o,t+2],[o-1,t+2]];break;case 2:S[b].poss=[[o,t],[o+1,t],[o+1,t+1],[o+2,t+1]];break;case 3:S[b].poss=[[o,t],[o+1,t],[o,t+1],[o-1,t+1]];break;case 4:S[b].poss=[[o,t],[o+1,t],[o+2,t],[o+3,t]];break;case 5:S[b].poss=[[o,t],[o,t+1],[o-1,t+1],[o+1,t+1]];break;case 6:S[b].poss=[[o,t],[o+1,t],[o,t+1],[o+1,t+1]]}}function D(e){let o=0,t=0;for(let e=0;e<4;e++)S[b].poss[e][0]+1!==r&&!0!==x[S[b].poss[e][1]][S[b].poss[e][0]+1].value||t++,(0===S[b].poss[e][0]||!0===x[S[b].poss[e][1]][S[b].poss[e][0]-1].value)&&o++;if(e&&0===t)for(let e=0;e<4;e++)S[b].poss[e][0]++;if(!e&&0===o)for(let e=0;e<4;e++)S[b].poss[e][0]--}function re(){for(var e=[[],[],[],[]],o=0;o<4;o++)e[o][0]=S[b].poss[o][0],e[o][1]=S[b].poss[o][1];let t=h,a=0;switch(b){case 0:if(1===t){if(0===e[0][0])break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,t++}else if(2===t){if(e[0][1]===i-1)break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][0]-=2,t++}else if(3===t){if(e[0][0]===r-1)break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,t++}else if(4===t){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][0]+=2,t=1}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t);break;case 1:if(1===t){if(e[0][0]===r-1)break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]+=2,t++}else if(2===t){if(0===e[0][1])break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][1]-=2,t++}else if(3===t){if(0===e[0][0])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]-=2,t++}else if(4===t){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][1]+=2,t=1}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t);break;case 2:if(1===t||3===t){if(0===e[0][1]||e[3][1]===i-1)break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,t++}else if(2===t||4===t){if(e[0][1]===i-1||0===e[0][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,t--}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t);break;case 3:if(1===t||3===t){if(0===e[1][1]||e[3][1]===i-1)break;e[1][0]--,e[1][1]--,e[2][0]++,e[2][1]--,e[3][0]+=2,t++}else if(2===t||4===t){if(e[1][1]===i-1||0===e[1][0])break;e[1][0]++,e[1][1]++,e[2][0]--,e[2][1]++,e[3][0]-=2,t--}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t);break;case 4:if(1===t||3===t){if(0===e[3][1]||e[3][1]>i-3)break;e[0][0]+=2,e[0][1]+=2,e[1][0]++,e[1][1]++,e[3][0]--,e[3][1]--,t++}else if(2===t||4===t){if(e[1][0]===r-1||e[1][0]<2||e[0][1]===i-1)break;e[0][0]-=2,e[0][1]-=2,e[1][0]--,e[1][1]--,e[3][0]++,e[3][1]++,t--}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t);break;case 5:if(1===t){if(e[3][1]===i-1)break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]++,e[3][0]--,e[3][1]--,t++}else if(2===t){if(e[2][1]===i-1||e[2][0]===r-1)break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]--,e[3][1]++,t++}else if(3===t){if(e[0][1]===i-1||0===e[3][1])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]--,e[3][0]++,e[3][1]++,t++}else if(4===t){if(e[3][1]===i-1||0===e[3][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]++,e[3][1]--,t=1}for(o=0;o<4;o++)!0===x[e[o][1]][e[o][0]].value&&a++;0===a&&(S[b].poss=e,h=t)}}function ie(e){switch(e.keyCode){case 65:case 37:p=!1,e.stopPropagation();break;case 68:case 39:v=!1,e.stopPropagation();break;case 83:case 40:d=!1,e.stopPropagation()}}function ne(e){switch(g=0,e.keyCode){case 65:case 37:v=!1,p=!0,e.stopPropagation();break;case 68:case 39:p=!1,v=!0,e.stopPropagation();break;case 87:case 38:re(),e.stopPropagation();break;case 83:case 40:d=!0,e.stopPropagation()}}(a=document.getElementById("tetris")).height=l,a.width=G,a.getContext&&(u=a.getContext("2d"),oe(),te()),window.addEventListener("keydown",ne,!0),window.addEventListener("keyup",ie,!0),document.querySelector(".rotate").addEventListener("click",re),q=document.querySelector(".move-right"),e&&q.addEventListener("touchstart",function(){P(!0)}),e||q.addEventListener("mousedown",function(){P(!0)}),q.addEventListener("mouseup",function(){m(!0)}),q.addEventListener("touchend",function(){m(!0)}),q=document.querySelector(".move-left"),e&&q.addEventListener("touchstart",function(){P(!1)}),e||q.addEventListener("mousedown",function(){P(!1)}),q.addEventListener("mouseup",function(){m(!1)}),q.addEventListener("touchend",function(){m(!1)}),q=document.querySelector(".move-down"),e&&q.addEventListener("touchstart",function(){d=!0,I()}),e||q.addEventListener("mousedown",function(){d=!0,I()}),q.addEventListener("mouseup",function(){d=!1}),q.addEventListener("touchend",function(){d=!1}),window.startTetris=function(){document.querySelector(".play").style.display="none",w=0,g=0,y=1,E=X,b=Math.floor(1e4*Math.random())%7,k=Math.floor(1e4*Math.random())%7,h=1,se();for(let o=0;o<i;o++)for(let e=0;e<r;e++)C[o][e].color=f,x[o][e].color=f,x[o][e].value=!1,T[o][e].color=f;N=setInterval(oe,60)};