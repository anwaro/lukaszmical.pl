const isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),numX=10,numY=16,LenCub=20,boardX=200,boardY=320,boardXwithMenu=300,BoardColor="#678893",stX=4,stY=0;let canvas,ctx,gameLoop,OneInLoop=0,downPress=!1,leftPress=!1,rightPress=!1,NumberCube=Math.floor(1e4*Math.random())%7,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1;const titleFontSize="bold 24px Georgia",MenuFontSize="bold 14px Georgia";let Score=0,Level=1;const initSpeed=10;let Speed=10;const fps=60;let move=0;const ColorCube={cub0:"#33CC33",cube0:"#259525",cub1:"#C670C6",cube1:"#9E5A9E",cub2:"#D1A319",cube2:"#A98414",cub3:"#FF6666",cube3:"#CC5252",cub4:"#5C5CD6",cube4:"#5353C1",cub5:"#E6E600",cube5:"#B8B800",cub6:"#FF8533",cube6:"#D1793E"};function startTetris(){ResetGame(),gameLoop=setInterval(DrawAll,60)}function END(e){move=0,e&&(rightPress=!1),!e&&(leftPress=!1)}function LR(e){rightPress=e,leftPress=!e,move=0,MoveCubeLR(e)}function initCanvas(){canvas=document.getElementById("tetris"),canvas.height=320,canvas.width=300,canvas.getContext&&(ctx=canvas.getContext("2d"),DrawAll(),DrawMenu()),window.addEventListener("keydown",keyPress,!0),window.addEventListener("keyup",keyUp,!0),document.querySelector(".rotate").addEventListener("click",TransformCube);const e=document.querySelector(".move-right");isMobile&&e.addEventListener("touchstart",(function(){LR(!0)})),!isMobile&&e.addEventListener("mousedown",(function(){LR(!0)})),e.addEventListener("mouseup",(function(){END(!0)})),e.addEventListener("touchend",(function(){END(!0)}));const o=document.querySelector(".move-left");isMobile&&o.addEventListener("touchstart",(function(){LR(!1)})),!isMobile&&o.addEventListener("mousedown",(function(){LR(!1)})),o.addEventListener("mouseup",(function(){END(!1)})),o.addEventListener("touchend",(function(){END(!1)}));const r=document.querySelector(".move-down");isMobile&&r.addEventListener("touchstart",(function(){downPress=!0,MoveCube()})),!isMobile&&r.addEventListener("mousedown",(function(){downPress=!0,MoveCube()})),r.addEventListener("mouseup",(function(){downPress=!1})),r.addEventListener("touchend",(function(){downPress=!1}))}function Block(e,o,r,u){this.poss=e,this.type=o,this.color=r,this.colorN=u}const AllBlock=[new Block([[4,0],[4,1],[4,2],[5,2]],1,ColorCube.cub0,ColorCube.cube0),new Block([[4,0],[4,1],[4,2],[3,2]],2,ColorCube.cub1,ColorCube.cube1),new Block([[4,0],[5,0],[5,1],[6,1]],3,ColorCube.cub2,ColorCube.cube2),new Block([[4,0],[5,0],[4,1],[3,1]],4,ColorCube.cub3,ColorCube.cube3),new Block([[4,0],[5,0],[6,0],[7,0]],5,ColorCube.cub4,ColorCube.cube4),new Block([[4,0],[4,1],[3,1],[5,1]],6,ColorCube.cub5,ColorCube.cube5),new Block([[4,0],[5,0],[4,1],[5,1]],7,ColorCube.cub6,ColorCube.cube6)];function OneCube(e,o,r,u){this.X=e,this.Y=o,this.value=r,this.color=u}const Board=[],CubeArea=[],NewArea=[];for(var i=0;i<16;i++){Board[i]=[],CubeArea[i]=[],NewArea[i]=[];for(var j=0;j<10;j++)Board[i][j]=new OneCube(20*j,20*i,1,"#678893"),NewArea[i][j]=new OneCube(20*j,20*i,!1,"#678893"),CubeArea[i][j]=new OneCube(20*j,20*i,!1,"#678893")}function ResetGame(){document.querySelector(".play").style.display="none",Score=0,move=0,Level=1,Speed=10,NumberCube=Math.floor(1e4*Math.random())%7,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1,ResetPosition();for(let e=0;e<16;e++)for(let o=0;o<10;o++)Board[e][o].color="#678893",CubeArea[e][o].color="#678893",CubeArea[e][o].value=!1,NewArea[e][o].color="#678893"}function DrawAll(){ctx.beginPath(),ctx.fillStyle="#678893",ctx.fillRect(0,0,200,320),ctx.beginPath(),ctx.moveTo(200,0),ctx.lineTo(200,320),ctx.stroke();for(var e=0;e<16;e++)for(var o=0;o<10;o++)Board[e][o].color="#678893";for(e=0;e<16;e++)for(o=0;o<10;o++)CubeArea[e][o].value&&(ctx.fillStyle=CubeArea[e][o].color,ctx.beginPath(),ctx.rect(CubeArea[e][o].X+1,CubeArea[e][o].Y+1,18,18),ctx.closePath(),ctx.fill());for(e=0;e<4;e++){const o=AllBlock[NumberCube].poss[e][0],r=AllBlock[NumberCube].poss[e][1];ctx.fillStyle=AllBlock[NumberCube].color,ctx.beginPath(),ctx.rect(Board[r][o].X+1,Board[r][o].Y+1,18,18),ctx.closePath(),ctx.fill()}(0===OneInLoop||downPress)&&MoveCube(),move&&leftPress&&MoveCubeLR(!1),move&&rightPress&&MoveCubeLR(!0),move++,OneInLoop=++OneInLoop%Speed}function DrawMenu(){ctx.beginPath(),ctx.fillStyle="#678893",ctx.fillRect(200,0,300,320),ctx.beginPath(),ctx.font=MenuFontSize,ctx.fillStyle="white",ctx.fillText("Next block ",208,20),ctx.fillText("Score: "+Score,208,110),ctx.fillText("Level: "+Level,208,130),DrawNextBlock()}function DrawNextBlock(){switch(NumberNextCube){case 0:DrawOneCube(215,30),DrawOneCube(215,50),DrawOneCube(215,70),DrawOneCube(235,70);break;case 1:DrawOneCube(235,30),DrawOneCube(235,50),DrawOneCube(235,70),DrawOneCube(215,70);break;case 2:DrawOneCube(235,30),DrawOneCube(235,50),DrawOneCube(215,50),DrawOneCube(215,70);break;case 3:DrawOneCube(215,30),DrawOneCube(215,50),DrawOneCube(235,50),DrawOneCube(235,70);break;case 4:DrawOneCube(210,30),DrawOneCube(230,30),DrawOneCube(250,30),DrawOneCube(270,30);break;case 5:DrawOneCube(235,30),DrawOneCube(215,50),DrawOneCube(235,50),DrawOneCube(255,50);break;case 6:DrawOneCube(215,30),DrawOneCube(215,50),DrawOneCube(235,50),DrawOneCube(235,30)}}function DrawOneCube(e,o){ctx.fillStyle=AllBlock[NumberNextCube].color,ctx.beginPath(),ctx.rect(e+1,o+1,18,18),ctx.closePath(),ctx.fill()}function ChoseNextCube(){for(let e=0;e<4;e++)CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]].value=!0,CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]].color=AllBlock[NumberCube].colorN;ResetPosition(),DeleteFullLayer(),NumberCube=NumberNextCube,NumberNextCube=Math.floor(1e4*Math.random())%7,NumTransform=1,CheckStatusGame(),DrawMenu()}function GameEnd(){clearInterval(gameLoop),ctx.font=titleFontSize,ctx.fillStyle="white",ctx.fillText("GAME OVER",15,130),document.querySelector(".play").style.display="block"}function CheckStatusGame(){for(let e=0;e<10;e++)if(!0===CubeArea[0][e].value)return GameEnd()}function DeleteFullLayer(){let e=0;for(var o=0;o<16;o++)for(var r=0;r<10;r++)NewArea[o][r].value=CubeArea[o][r].value,NewArea[o][r].color=CubeArea[o][r].color;for(o=0;o<16;o++){for(r=0;r<10;r++)!0===CubeArea[o][r].value&&e++;if(10===e){Score++,Level=Math.ceil(Score/40),Speed=10-Level;for(var u=0;u<=o;u++)for(var l=0;l<10;l++)0===u?(NewArea[u][l].value=!1,NewArea[u][l].color="#678893"):(NewArea[u][l].value=CubeArea[u-1][l].value,NewArea[u][l].color=CubeArea[u-1][l].color);for(u=0;u<16;u++)for(l=0;l<10;l++)CubeArea[u][l].value=NewArea[u][l].value,CubeArea[u][l].color=NewArea[u][l].color}e=0}}function MoveCube(){let e=0;for(var o=0;o<4;o++)AllBlock[NumberCube].poss[o][1]+1!==16&&!0!==CubeArea[AllBlock[NumberCube].poss[o][1]+1][AllBlock[NumberCube].poss[o][0]].value||e++;if(0===e)for(o=0;o<4;o++)AllBlock[NumberCube].poss[o][1]++;else ChoseNextCube()}function ResetPosition(){switch(NumberCube){case 0:AllBlock[NumberCube].poss=[[4,0],[4,1],[4,2],[5,2]];break;case 1:AllBlock[NumberCube].poss=[[4,0],[4,1],[4,2],[3,2]];break;case 2:AllBlock[NumberCube].poss=[[4,0],[5,0],[5,1],[6,1]];break;case 3:AllBlock[NumberCube].poss=[[4,0],[5,0],[4,1],[3,1]];break;case 4:AllBlock[NumberCube].poss=[[4,0],[5,0],[6,0],[7,0]];break;case 5:AllBlock[NumberCube].poss=[[4,0],[4,1],[3,1],[5,1]];break;case 6:AllBlock[NumberCube].poss=[[4,0],[5,0],[4,1],[5,1]]}}function MoveCubeLR(e){let o=0,r=0;for(let e=0;e<4;e++)(AllBlock[NumberCube].poss[e][0]+1===10||!0===CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]+1].value)&&r++,(0===AllBlock[NumberCube].poss[e][0]||!0===CubeArea[AllBlock[NumberCube].poss[e][1]][AllBlock[NumberCube].poss[e][0]-1].value)&&o++;if(e&&0===r)for(let e=0;e<4;e++)AllBlock[NumberCube].poss[e][0]++;if(!e&&0===o)for(let e=0;e<4;e++)AllBlock[NumberCube].poss[e][0]--}function TransformCube(){const e=[[],[],[],[]];for(var o=0;o<4;o++)e[o][0]=AllBlock[NumberCube].poss[o][0],e[o][1]=AllBlock[NumberCube].poss[o][1];let r=NumTransform,u=0;switch(NumberCube){case 0:if(1===r){if(0===e[0][0])break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,r++}else if(2===r){if(15===e[0][1])break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][0]-=2,r++}else if(3===r){if(9===e[0][0])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,r++}else if(4===r){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][0]+=2,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 1:if(1===r){if(9===e[0][0])break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]+=2,r++}else if(2===r){if(0===e[0][1])break;e[0][0]++,e[0][1]++,e[2][0]--,e[2][1]--,e[3][1]-=2,r++}else if(3===r){if(0===e[0][0])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]-=2,r++}else if(4===r){if(0===e[0][1])break;e[0][0]--,e[0][1]--,e[2][0]++,e[2][1]++,e[3][1]+=2,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 2:if(1===r||3===r){if(0===e[0][1]||15===e[3][1])break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][1]-=2,r++}else if(2===r||4===r){if(15===e[0][1]||0===e[0][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][1]+=2,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 3:if(1===r||3===r){if(0===e[1][1]||15===e[3][1])break;e[1][0]--,e[1][1]--,e[2][0]++,e[2][1]--,e[3][0]+=2,r++}else if(2===r||4===r){if(15===e[1][1]||0===e[1][0])break;e[1][0]++,e[1][1]++,e[2][0]--,e[2][1]++,e[3][0]-=2,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 4:if(1===r||3===r){if(0===e[3][1]||e[3][1]>13)break;e[0][0]+=2,e[0][1]+=2,e[1][0]++,e[1][1]++,e[3][0]--,e[3][1]--,r++}else if(2===r||4===r){if(9===e[1][0]||e[1][0]<2||15===e[0][1])break;e[0][0]-=2,e[0][1]-=2,e[1][0]--,e[1][1]--,e[3][0]++,e[3][1]++,r--}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r);break;case 5:if(1===r){if(15===e[3][1])break;e[0][0]--,e[0][1]++,e[2][0]++,e[2][1]++,e[3][0]--,e[3][1]--,r++}else if(2===r){if(15===e[2][1]||9===e[2][0])break;e[0][0]++,e[0][1]++,e[2][0]++,e[2][1]--,e[3][0]--,e[3][1]++,r++}else if(3===r){if(15===e[0][1]||0===e[3][1])break;e[0][0]++,e[0][1]--,e[2][0]--,e[2][1]--,e[3][0]++,e[3][1]++,r++}else if(4===r){if(15===e[3][1]||0===e[3][0])break;e[0][0]--,e[0][1]--,e[2][0]--,e[2][1]++,e[3][0]++,e[3][1]--,r=1}for(o=0;o<4;o++)!0===CubeArea[e[o][1]][e[o][0]].value&&u++;0===u&&(AllBlock[NumberCube].poss=e,NumTransform=r)}}function keyUp(e){switch(e.keyCode){case 65:case 37:leftPress=!1,e.stopPropagation();break;case 68:case 39:rightPress=!1,e.stopPropagation();break;case 83:case 40:downPress=!1,e.stopPropagation()}}function keyPress(e){switch(move=0,e.keyCode){case 65:case 37:rightPress=!1,leftPress=!0,e.stopPropagation();break;case 68:case 39:leftPress=!1,rightPress=!0,e.stopPropagation();break;case 87:case 38:TransformCube(),e.stopPropagation();break;case 83:case 40:downPress=!0,e.stopPropagation()}}initCanvas();