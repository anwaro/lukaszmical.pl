function Point(e,t){this.x=e,this.y=t,this.t}function Draw(){this.type,this.color,this.width,this.point=[]}$$Draw=new function(){var isMobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),canvas,canvasCover,ctx,ctxCover,mouseX,mouseY,shiftDown=!1,controlDown=!1,canvasWidth=800,canvasHeight=400,drawing=[],memory=[],currentDraw,currentType="line",backgroundColor="black",isDraw=!1,currentColor="white",currentWidth=3,menu,color,size,sizeUp,sizeDown,type,undo,redo,textColor="white",textBold=!1,textUnder=!1,textItalic=!1,textSize=13,textFont="";function setElement(){canvas=$$("#drawCanvas"),canvasCover=$$("#drawCanvasCover"),menu=$$("#menu"),color=$$("#in_color"),size=$$("#size"),sizeUp=$$("#sizeUp"),sizeDown=$$("#sizeDown"),type=$$("#type"),undo=$$("#undo"),redo=$$("#redo")}function setEvent(){canvasCover.addEventListener("mousemove",mousePossition),canvasCover.addEventListener("mousedown",drawStart),canvasCover.addEventListener("mouseup",drawEnd),canvasCover.addEventListener("mouseleave",drawEnd),canvasCover.addEventListener("mouseover",getOption),undo.addEventListener("click",undoF),redo.addEventListener("click",redoF),$$("#clean").addEventListener("click",clean),document.addEventListener("keydown",keyDown),document.addEventListener("keyup",keyUp),canvasCover.addEventListener("touchstart",touchStart,!1),document.addEventListener("touchmove",touchMove,!1)}function clean(){confirm("Czy na pewno chcesz porzuciÄ‡ zmiany?")&&(memory=[],drawing=[],redo.removeClass("on"),undo.removeClass("on"),drawBackground())}function draw(){var e;ctxCover.clearRect(0,0,canvasWidth,canvasHeight),isDraw&&("line"===currentDraw.type&&5<distance((e=currentDraw.point)[e.length-1],{x:mouseX,y:mouseY})&&currentDraw.point.push(new Point(mouseX,mouseY)),drawElement(currentDraw,!0,ctxCover)),"line"===currentType&&(ctxCover.fillStyle=currentColor,ctxCover.beginPath(),ctxCover.arc(mouseX,mouseY,currentWidth/2,0,2*Math.PI,!0),ctxCover.closePath(),ctxCover.fill())}function drawBackground(){ctx.fillStyle=backgroundColor,ctx.fillRect(0,0,canvasWidth,canvasHeight);for(var e=0;e<drawing.length;e++)drawElement(drawing[e],!1,ctx)}function drawElement(e,t,n){var o=t?{x:mouseX,y:mouseY}:{x:e.point[1].x,y:e.point[1].y};n.strokeStyle=e.color,n.fillStyle=e.color,n.lineCap="round",n.beginPath(),"line"===e.type&&1<e.point.length?e.point[0].x!==e.point[1].x||e.point[0].y!==e.point[1].y?(n.moveTo(e.point[0].x,e.point[0].y),n.curve(arrObjToArray(e.point),.4,5,0),n.lineWidth=e.width,n.stroke()):(n.arc(e.point[0].x,e.point[0].y,e.width/2,0,2*Math.PI,!0),n.closePath(),n.fill()):"straightLine"===e.type?(n.moveTo(e.point[0].x,e.point[0].y),shiftDown&&t?Math.abs(e.point[0].x-o.x)<Math.abs(e.point[0].y-o.y)?n.lineTo(e.point[0].x,o.y):n.lineTo(o.x,e.point[0].y):n.lineTo(o.x,o.y),n.lineWidth=e.width,n.stroke()):"arcStroke"===e.type?(n.arc(e.point[0].x,e.point[0].y,distance(o,e.point[0]),0,2*Math.PI,!0),n.lineWidth=e.width,n.closePath(),n.stroke()):"arcFill"===e.type?(n.arc(e.point[0].x,e.point[0].y,distance(o,e.point[0]),0,2*Math.PI,!0),n.closePath(),n.fill()):"rectStroke"===e.type?(n.rect(e.point[0].x,e.point[0].y,o.x-e.point[0].x,o.y-e.point[0].y),n.lineWidth=e.width,n.closePath(),n.stroke()):"rectFill"===e.type&&(n.rect(e.point[0].x,e.point[0].y,o.x-e.point[0].x,o.y-e.point[0].y),n.closePath(),n.fill())}function drawStart(){getOption(),(currentDraw=new Draw).type=currentType,currentDraw.color=currentColor,currentDraw.width=currentWidth,currentDraw.point.push(new Point(mouseX,mouseY)),isDraw=!0}function getOption(){currentColor=color.value,"q1"===type.dataset.type?currentType="line":"q2"===type.dataset.type?currentType="straightLine":"q3"===type.dataset.type?currentType="arcStroke":"q4"===type.dataset.type?currentType="rectStroke":"q5"===type.dataset.type?currentType="rectFill":"q6"===type.dataset.type&&(currentType="arcFill"),textColor=$$("#fontColor").value,textBold=$$("#bold").hasClass("on"),textUnder=$$("#under").hasClass("on"),textItalic=$$("#italic").hasClass("on"),textSize=$$("#lineS").innerHTML,textFont="",currentWidth=$$("#lineW").innerHTML}function drawEnd(){isDraw&&("straightLine"===currentDraw.type&&shiftDown?Math.abs(currentDraw.point[0].x-mouseX)<Math.abs(currentDraw.point[0].y-mouseY)?currentDraw.point.push(new Point(currentDraw.point[0].x,mouseY)):currentDraw.point.push(new Point(mouseX,currentDraw.point[0].y)):currentDraw.point.push(new Point(mouseX,mouseY)),drawing.push(currentDraw),isDraw=!1,$$("#saveImg").href=canvas.toDataURL(),1===drawing.length&&undo.addClass("on"),redo.removeClass("on"),memory=[],drawBackground())}function undoF(){drawing.length&&(memory.push(drawing[drawing.length-1]),drawing.pop(),redo.hasClass("on")||redo.addClass("on"),drawBackground()),drawing.length||undo.removeClass("on")}function redoF(){memory.length&&(drawing.push(memory[memory.length-1]),memory.pop(),undo.hasClass("on")||undo.addClass("on"),memory.length||redo.removeClass("on"),drawBackground())}function keyDown(e){switch(e.keyCode){case 17:controlDown=!0,e.preventDefault();break;case 16:shiftDown=!0,e.preventDefault();break;case 90:controlDown&&undoF(),e.preventDefault();break;case 89:controlDown&&redoF(),e.preventDefault();break;case 83:controlDown&&$$("#saveImg").click(),e.preventDefault();break;case 78:controlDown&&$$("#clean").click(),e.preventDefault()}}function keyUp(e){switch(e.keyCode){case 17:controlDown=!1,e.preventDefault();break;case 16:shiftDown=!1,e.preventDefault()}}function mousePossition(e){var t=canvasCover.getBoundingClientRect();mouseX=e.clientX-t.left,mouseY=e.clientY-t.top}function touchStart(e){1===e.touches.length&&(e.preventDefault(),mouseX=e.touches[0].pageX-.5*(window.innerWidth-canvasWidth),mouseY=e.touches[0].pageY-.5*(window.innerHeight-canvasHeight))}function touchMove(e){1===e.touches.length&&(e.preventDefault(),mouseX=e.touches[0].pageX-.5*(window.innerWidth-canvasWidth),mouseY=e.touches[0].pageY-.5*(window.innerHeight-canvasHeight)-20)}function distance(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y))}function arrObjToArray(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].x),t.push(e[n].y);return t}this.test=function(s){return eval(s)},this.init=function(){setElement(),canvasCover.width=canvas.width=canvasWidth,canvasCover.height=canvas.height=canvasHeight,canvas&&canvas.getContext&&canvasCover&&canvasCover.getContext&&(ctx=canvas.getContext("2d"),ctxCover=canvasCover.getContext("2d"),setEvent(),drawBackground(),isMobile?setInterval(draw,1e3/30):setInterval(draw,1e3/60))}},$$Draw.init(),CanvasRenderingContext2D.prototype.curve=function(e,m,g,t){m="number"==typeof m?m:.5,g=g||25;var n,o=(e.length-2)*g+2+(t?2*g:0),f=0,x=new Float32Array(o),r=e.length,a=new Float32Array(4*(g+2)),i=4,o=e.slice(0);for(t?(o.unshift(e[r-1]),o.unshift(e[r-2]),o.push(e[0],e[1])):(o.unshift(e[1]),o.unshift(e[0]),o.push(e[r-2],e[r-1])),n=a[0]=1;n<g;n++){var s=n/g,c=s*s,u=c*s,d=2*u,l=3*c;a[i++]=d-l+1,a[i++]=l-d,a[i++]=u-2*c+s,a[i++]=u-c}function h(e,t,n){for(var o=2;o<n;o+=2)for(var r=e[o],a=e[o+1],i=e[o+2],s=e[o+3],c=(i-e[o-2])*m,u=(s-e[o-1])*m,d=(e[o+4]-r)*m,l=(e[o+5]-a)*m,h=0;h<g;h++){var p=h<<2,v=t[p],w=t[1+p],y=t[2+p],p=t[3+p];x[f++]=v*r+w*i+y*c+p*d,x[f++]=v*a+w*s+y*u+p*l}}for(a[++i]=1,h(o,a,r),t&&((o=[]).push(e[r-4],e[r-3],e[r-2],e[r-1]),o.push(e[0],e[1],e[2],e[3]),h(o,a,4)),r=t?0:e.length-2,x[f++]=e[r],x[f]=e[1+r],n=0,r=x.length;n<r;n+=2)this.lineTo(x[n],x[n+1]);return x};