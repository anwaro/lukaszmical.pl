function Point(e,t){this.x=e||0,this.y=t||0}mathcode=function(e,t){var c=e,o=t,l=(u(o,"mathcode"),c.style.width="1px",c.style.position="absolute",c.style.left="-99999px",o.parentNode.appendChild(c),["br","op","va","nu","co","fu"]),m=[/\(|\)/,/\/|\*|\-|\+|\.|\^/,/x/,/\d/,/e|E|pi|Pi|PI/,/\w/];function a(e){var t=c.value,a=t.length,n=function(){var e=0;{var t;document.selection?(c.focus(),(t=document.selection.createRange()).moveStart("character",-c.value.length),e=t.text.length):!c.selectionStart&&"0"!=c.selectionStart||(e=c.selectionStart)}return e}();o.innerHTML="",e&&"("===t.slice(n-1,n)&&57===e.which&&(t=t.slice(0,n)+")"+t.slice(n,a),e.target.value=t,a++,s(n)),e&&")"===t.slice(n-1,n)&&48===e.which&&")"===t.slice(n,n+1)&&(t=t.slice(0,n-1)+t.slice(n,a),e.target.value=t,a--,s(n)),o.appendChild(x("",0===n?"cursor":"empty"));for(var i=0;i<a;i++){char=t[i],i+1<a&&/pi/i.test(char+t[i+1])?char+=t[i+1]:1<i&&/pi/i.test(t[i-1]+char)&&(char=t[i-1]+char);var r=function(e){for(var t=0;t<m.length;t++)if(m[t].test(e))return l[t]}(char),r=x(t[i],r);n===i+1&&(r=u(r,"cursor")),o.appendChild(r)}d()}function s(e){var t;c.setSelectionRange?(c.focus(),c.setSelectionRange(e,e)):c.createTextRange&&((t=c.createTextRange()).collapse(!0),t.moveEnd("character",e),t.moveStart("character",e),t.select())}function u(e,t){return e.classList.add(t),e}function x(e,t){var a=document.createElement("div");return a.innerHTML=e,a.classList.add("mb"),a.classList.add(t),a.addEventListener("click",n),a}function d(){c.focus()}function n(e){var e=e.target,t=document.getElementsByClassName("cursor")[0];t&&t.classList.remove("cursor"),u(e,"cursor"),s([].indexOf.call(e.parentNode.children,e)),d()}a(),o.addEventListener("mouseup",d),c.addEventListener("keyup",a),c.addEventListener("focus",function(){o.classList.remove("inactive"),u(o,"active")}),c.addEventListener("focusout",function(){o.classList.remove("active"),u(o,"inactive")})},$math=new function(){var canvas,ctx,fun,data=[],stringFile="",x,y,labelActive=!0,scrollActive=!1,lineActive=!1,pointActive=!0,minX,maxX,stepX,labX=0,minY,maxY,stepY,labY=0,descx,descy,margin=40,mouseX,mouseY,label=!1,proces=!1,dataType="fun",sepPoint=";",sepXY=",";function changeActive(){labelActive=document.getElementById("label").checked,scrollActive=document.getElementById("scroll").checked,pointActive=document.getElementById("point").checked,lineActive=document.getElementById("line").checked,setTimeout(draw,10)}function intMathCode(){var e=document.getElementById("function"),t=e.parentNode;mathcode(e,t)}function changeData(){var e=document.querySelector(".d-file1"),t=document.querySelector(".d-file2"),a=document.querySelector(".d-fun1"),n=document.querySelector(".d-fun2"),i=document.querySelector(".d-fun3");proces=e.classList.contains("off")?(a.classList.add("off"),n.classList.add("off"),i.classList.add("off"),e.classList.remove("off"),t.classList.remove("off"),dataType="file",!0):(e.classList.add("off"),t.classList.add("off"),a.classList.remove("off"),n.classList.remove("off"),i.classList.remove("off"),!(dataType="fun"))}function drawLabel(){var e,t,a,n,i,r,c;ctx.clearRect(0,0,x,y),label&&!proces&&labelActive&&(r=(y-2*margin)/(maxY-minY),t=getFunctionValue(e=(mouseX-margin)/(i=(x-2*margin)/(maxX-minX))+minX),a="x: "+fixNumber(e,stepX/10),a=10*((n="y: "+fixNumber(t,stepY/10)).length<a.length?a.length+2:n.length+2),labX+=.15*((n=margin+(e-minX)*i)-labX),labY+=.15*((i=margin+(maxY-t)*r)-labY),labX=isNaN(labX)?0:labX,labY=isNaN(labY)?0:labY,r=labX+10+a<x?labX+10:x-a-5,c=labY-65<5?5:labY-65,ctx.beginPath(),ctx.fillStyle="rgba(0, 122, 126, 0.6)",ctx.strokeStyle="rgba(0, 122, 126, 0.6)",ctx.lineWidth=3,ctx.fillRect(r,c,a,60),ctx.moveTo(n,i),ctx.lineTo(r+2,60+c),ctx.stroke(),ctx.beginPath(),ctx.font="17pt Calibri",ctx.fillStyle="black",ctx.textAlign="left",ctx.textBaseline="top",ctx.fillText("x: "+fixNumber(e,stepX/10),r+10,c),ctx.fillText("y: "+fixNumber(t,stepY/10),r+10,25+c),ctx.beginPath(),ctx.arc(n,i,2,0,2*Math.PI,!0),ctx.fill())}function draw(){proces=!0,("fun"===dataType?prepareDataFromFunction:prepareDataFromFile)(),ctx.clearRect(0,0,x,y),drawAxis(),drawGraph(),axisDesc(),document.getElementById("down").href=canvas.toDataURL(),canvas.style.background="url("+canvas.toDataURL()+")",ctx.clearRect(0,0,x,y),proces=!1}function mousePossition(e){var t=canvas.getBoundingClientRect();mouseX=e.clientX-t.left,mouseY=e.clientY-t.top}function scrollCanv(e){!proces&&scrollActive&&(e.preventDefault(),minX=parseFloat(document.querySelector("#xmin").value.replace(",",".")),maxX=parseFloat(document.querySelector("#xmax").value.replace(",",".")),document.querySelector("#xmin").value=fixNumber(0<e.deltaY?minX+.6*stepX*(mouseX/x):minX-.6*stepX*(mouseX/x),stepX/10),document.querySelector("#xmax").value=fixNumber(0<e.deltaY?maxX-.6*stepX*(1-mouseX/x):maxX+.6*stepX*(1-mouseX/x),stepX/10),draw())}function prepareDataFromFunction(){if(getOptionFromFunction(),checkFunction()){stepX=fixStep(maxX-minX),data=[];for(var line=[],val,x=minX;x<=maxX;x+=1e-4*Math.abs(maxX-minX))val=eval(fun),val<1e10&&-1e10<val?(maxY<val&&(maxY=val),val<minY&&(minY=val),line.push(new Point(x,val))):(1<line.length&&data.push(line),line=[]);1<line.length&&data.push(line),maxY===minY&&(maxY+=5,minY-=5),stepY=fixStep(maxY-minY)}else functionSyntaxError()}function getFunctionValue(x){var val=0;try{val=eval(fun)}catch(e){}return val}function prepareDataFromFile(){getOptionFromFile();for(var e,t=stringFile.split(sepPoint),a=[],n=0;n<t.length;n++)-1<t[n].indexOf(sepXY)&&(e=t[n].split(sepXY),a.push([Number(e[0]),Number(e[1])]));quick_sort(a),maxX=maxValue(a,0),minX=minValue(a,0),maxY=maxValue(a,1),minY=minValue(a,1),maxY===minY&&(maxY+=5,minY-=5),maxX===minX&&(maxX+=5,minX-=5);var i=[];data=[];for(n=0;n<a.length;n++)i.push(new Point(a[n][0],a[n][1]));data.push(i),stepY=fixStep(maxY-minY),stepX=fixStep(maxX-minX)}function maxValue(e,t){for(var a=e[0][t],n=0;n<e.length;n++)a=a<e[n][t]?e[n][t]:a;return a}function minValue(e,t){for(var a=e[0][t],n=0;n<e.length;n++)a=a>e[n][t]?e[n][t]:a;return a}function loadData(){var e=new FileReader,t=document.getElementById("file").files[0];e.onload=function(e){stringFile=e.target.result.replace(/(\r\n|\n|\r)/gm,"")},e.readAsText(t)}function partition(e,t,a,n){for(var i=e[n][0],r=(e.swap(n,a-1),t),c=t;c<a-1;++c)e[c][0]<=i&&(e.swap(r,c),++r);return e.swap(a-1,r),r}function qsort(e,t,a){t<a-1&&(qsort(e,t,t=partition(e,t,a,t+Math.floor(Math.random()*(a-t)))),qsort(e,t+1,a))}function quick_sort(e){qsort(e,0,e.length)}function drawGraph(){ctx.beginPath();var e=(x-2*margin)/(maxX-minX),t=(y-2*margin)/(maxY-minY);if(ctx.strokeStyle="red",ctx.lineWidth=4,lineActive){for(var a in ctx.moveTo(margin+(data[0][0].x-minX)*e,margin+(maxY-data[0][0].y)*t),data)for(var n in data[a])ctx.lineTo(margin+(data[a][n].x-minX)*e,margin+(maxY-data[a][n].y)*t);ctx.stroke()}if(ctx.beginPath(),ctx.fillStyle="blue",pointActive)for(var a in data)for(var n in data[a])ctx.beginPath(),ctx.arc(margin+(data[a][n].x-minX)*e,margin+(maxY-data[a][n].y)*t,1,0,2*Math.PI,!0),ctx.closePath(),ctx.fill()}function drawAxis(){var e=x-2*margin,t=y-2*margin,a=e/(maxX-minX),n=t/(maxY-minY),i=(i=maxY*n)<0?0:t<i?t:i,r=(r=-minX*a)<0?0:e<r?e:r;if(ctx.beginPath(),ctx.strokeStyle="black",ctx.fillStyle="black",ctx.font="margin/2pt Calibri",ctx.lineWidth=.5,ctx.moveTo(margin/2,i+margin),ctx.lineTo(x-margin/2,i+margin),ctx.lineTo(x-margin/2-5,i+margin+3),ctx.lineTo(x-margin/2-5,i+margin-3),ctx.lineTo(x-margin/2,i+margin),ctx.moveTo(r+margin,y-margin/2),ctx.lineTo(r+margin,margin/2),ctx.lineTo(r+margin+3,margin/2+5),ctx.lineTo(r+margin-3,margin/2+5),ctx.lineTo(r+margin,margin/2),ctx.stroke(),0<maxY)for(var c=0;c<maxY+stepY;c+=stepY)minY<=c&&(ctx.moveTo(r+margin-5,margin+(maxY-c)*n),ctx.lineTo(r+margin+5,margin+(maxY-c)*n),ctx.stroke(),ctx.fillText(fixNumber(c,stepY),r+margin-20,margin+(maxY-c)*n));if(minY<0)for(c=0;minY-stepY<c;c-=stepY)c<maxY&&(ctx.moveTo(r+margin-5,margin+(maxY-c)*n),ctx.lineTo(r+margin+5,margin+(maxY-c)*n),ctx.stroke(),ctx.fillText(fixNumber(c,stepY),r+margin-20,margin+(maxY-c)*n));if(0<maxX)for(c=0;c<maxX+stepX;c+=stepX)minX<=c&&(ctx.moveTo(margin+(c-minX)*a,i+margin-5),ctx.lineTo(margin+(c-minX)*a,i+margin+5),ctx.stroke(),ctx.fillText(fixNumber(c,stepX),margin+(c-minX)*a,i+margin+18));if(minX<0)for(c=0;minX-stepX<c;c-=stepX)c<maxX&&(ctx.moveTo(margin+(c-minX)*a,i+margin-5),ctx.lineTo(margin+(c-minX)*a,i+margin+5),ctx.stroke(),ctx.fillText(fixNumber(c,stepX),margin+(c-minX)*a,i+margin+18))}function fixNumber(e,t){if(0===e)return 0;for(var a=0;t<1;)t*=margin/2,a++;return e.toFixed(a+1)}function fixStep(e){var t=1;if((e/=8)<1){for(;e<1;)e*=margin/2,t*=margin/2;e=round(e)/t}else if(e<margin/2)e=round(e);else{for(;margin/2<e;)e/=margin/2,t*=margin/2;e=round(e)*t}return e}function axisDesc(){ctx.font="14pt Calibri",ctx.fillStyle="black",ctx.textAlign="center",ctx.textBaseline="top",ctx.fillText(descx,x/2,y+16-margin),ctx.save(),ctx.rotate(-Math.PI/2),ctx.textAlign="center",ctx.fillText(descy,-y/2,2),ctx.restore()}function round(e){return Math.floor(e)}function preperFunction(e){for(var t,a={abs:"Math.abs",acos:"Math.acos",asin:"Math.asin",atan:"Math.atan",atan2:"Math.atan2",cos:"Math.cos",exp:"Math.exp",floor:"Math.floor",log:"Math.log",pow:"Math.pow",rand:"Math.random()",round:"Math.round",sin:"Math.sin",sqrt:"Math.sqrt",tan:"Math.tan",PI:"Math.PI",pi:"Math.PI",Pi:"Math.PI",E:"Math.E",e:"Math.E"},n=[[/(\d+|x|e|\(.+\))(\^|\*\*)(\d+|x|e|\(.+\))/g,"pow($1, $3)"]],i=0;i<n.length;i++)e=e.replace(n[i][0],n[i][1]);for(t in a){var r=new RegExp(t,"g");e=e.replace(r,a[t])}return document.querySelector("#out-fun"),document.querySelector("#out-fun").innerHTML=e,document.querySelector("#out-fun").style.background="#C7FFC7",e}function getOptionFromFunction(){x=parseInt(document.querySelector("#x").value),y=parseInt(document.querySelector("#y").value),x=canvas.width=x<300?300:1500<x?1500:x,y=canvas.height=y<300?300:1500<y?1500:y,maxY=-9e10,minY=9e10,descx=document.querySelector("#descx").value,descy=document.querySelector("#descy").value,fun=preperFunction(document.querySelector("#function").value),minX=parseFloat(document.querySelector("#xmin").value.replace(",",".")),(maxX=parseFloat(document.querySelector("#xmax").value.replace(",",".")))<=minX&&(minX=0,maxX=10)}function getOptionFromFile(){x=parseInt(document.querySelector("#x").value),y=parseInt(document.querySelector("#y").value),x=canvas.width=x<300?300:1500<x?1500:x,y=canvas.height=y<300?300:1500<y?1500:y,maxY=-9e10,minY=9e10,descx=document.querySelector("#descx").value,descy=document.querySelector("#descy").value,sepPoint=document.querySelector("#point-seperator").value,sepXY=document.querySelector("#xy-seperator").value}function checkFunction(){try{var x=6;val=eval(fun)}catch(e){return}return 1}function functionSyntaxError(){document.querySelector("#out-fun").style.background="#FFC7C7"}this.init=function(){(canvas=document.querySelector("#mathCanvas"))&&(canvas.height=500,canvas.width=600,ctx=canvas.getContext("2d"),document.getElementById("draw").addEventListener("click",draw),canvas.addEventListener("mousemove",mousePossition),canvas.addEventListener("mouseover",function(){label=!0}),canvas.addEventListener("mouseleave",function(){label=!1}),intMathCode(),canvas.addEventListener("wheel",scrollCanv),document.getElementById("data-function").addEventListener("change",changeData),document.getElementById("data-file").addEventListener("change",changeData),document.getElementById("file").addEventListener("change",loadData),document.getElementById("label").addEventListener("change",changeActive),document.getElementById("scroll").addEventListener("change",changeActive),document.getElementById("point").addEventListener("change",changeActive),document.getElementById("line").addEventListener("change",changeActive),draw(),setInterval(drawLabel,1e3/30))}},Array.prototype.swap=function(e,t){var a=this[e];this[e]=this[t],this[t]=a},$math.init();